<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A scheduler for managing and executing flows and triggers within the application context.

# Purpose
The [`DefaultScheduler`](<#defaultschedulerdefaultscheduler>) class in the `io.kestra.core.schedulers` package is responsible for managing the scheduling of tasks within the Kestra workflow orchestration system. It extends the `AbstractScheduler` class and is annotated with `@Singleton`, indicating that it is a singleton component within the application context. The class integrates with various services and interfaces, such as `ConditionService`, `FlowRepositoryInterface`, and `SchedulerTriggerStateInterface`, to facilitate the scheduling and execution of workflows based on defined triggers.

The [`DefaultScheduler`](<#defaultschedulerdefaultscheduler>) class primarily handles the reception and processing of `Execution` and `Trigger` objects from their respective queues. It uses the `QueueInterface` to receive these objects and processes them to manage the state of triggers and executions. The class maintains a map of active triggers, `watchingTrigger`, to track ongoing executions. It updates the state of triggers based on the execution's current state and conditions evaluated by the `ConditionService`. The [`handleNext`](<#defaultschedulerhandlenext>) method is used to determine the next set of triggers to be executed, filtering them based on their scheduled execution dates. This class is a central component in the scheduling mechanism, ensuring that workflows are executed according to their defined schedules and conditions.
# Imports and Dependencies

---
- `io.kestra.core.schedulers`
- `io.kestra.core.models.executions.Execution`
- `io.kestra.core.models.flows.Flow`
- `io.kestra.core.models.triggers.Trigger`
- `io.kestra.core.queues.QueueFactoryInterface`
- `io.kestra.core.queues.QueueInterface`
- `io.kestra.core.repositories.FlowRepositoryInterface`
- `io.kestra.core.services.ConditionService`
- `io.kestra.core.services.FlowListenersInterface`
- `io.kestra.core.utils.Await`
- `io.micronaut.context.ApplicationContext`
- `io.micronaut.inject.qualifiers.Qualifiers`
- `jakarta.inject.Inject`
- `jakarta.inject.Singleton`
- `lombok.extern.slf4j.Slf4j`
- `java.time.Duration`
- `java.time.ZonedDateTime`
- `java.util.List`
- `java.util.Map`
- `java.util.concurrent.ConcurrentHashMap`
- `java.util.function.BiConsumer`


# Classes

---
### DefaultScheduler<!-- {{#class:io.kestra.core.schedulers.DefaultScheduler}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L25>)

- **Modifiers**: `public`
- **Description**: Manages the scheduling of tasks by handling execution and trigger queues, updating trigger states, and coordinating with flow repositories and condition services.
- **Fields**:
    - `watchingTrigger`: `Map<String, Trigger>` A map that stores triggers currently being watched, keyed by execution ID.
    - `conditionService`: `ConditionService` A service used to check conditions related to executions and flows.
    - `flowRepository`: `FlowRepositoryInterface` An interface for accessing flow data from a repository.
- **Methods**:
    - [`io.kestra.core.schedulers.DefaultScheduler.DefaultScheduler`](<#defaultschedulerdefaultscheduler>)
    - [`io.kestra.core.schedulers.DefaultScheduler.run`](<#defaultschedulerrun>)
    - [`io.kestra.core.schedulers.DefaultScheduler.handleNext`](<#defaultschedulerhandlenext>)
- **Extends/Implements**:
    - `AbstractScheduler`

**Methods**

---
#### DefaultScheduler\.DefaultScheduler<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.DefaultScheduler}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L35>)

Initializes a `DefaultScheduler` instance with the given application context, flow listeners, and trigger state, and sets up necessary services.
- **Modifiers**: `public`
- **Inputs**:
    - `applicationContext`: The `ApplicationContext` used to retrieve beans and manage the application environment.
    - `flowListeners`: The `FlowListenersInterface` used to manage flow listeners.
    - `triggerState`: The `SchedulerTriggerStateInterface` used to manage the state of triggers.
- **Control Flow**:
    - Call the superclass constructor with `applicationContext` and `flowListeners`.
    - Assign the `triggerState` parameter to the `triggerState` field of the class.
    - Retrieve the `ConditionService` bean from the `applicationContext` and assign it to the `conditionService` field.
    - Retrieve the `FlowRepositoryInterface` bean from the `applicationContext` and assign it to the `flowRepository` field.
- **Output**:
    - No output is returned as this is a constructor.
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)


---
#### DefaultScheduler\.run<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.run}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L48>)

Processes execution and trigger messages from their respective queues and updates the trigger state accordingly.
- **Modifiers**: `public`, `override`
- **Inputs**: None
- **Control Flow**:
    - Retrieve the `executionQueue` and `triggerQueue` beans from the application context using their respective qualifiers.
    - Receive messages from the `executionQueue`.
    - Check if the message from `executionQueue` is deserialized correctly; log an error if not.
    - If the execution has a trigger, retrieve the trigger from `watchingTrigger` with a timeout of 5 seconds.
    - Find the flow associated with the execution using `flowRepository`.
    - Check if the execution is deleted or terminated with listeners; if so, update the trigger state and remove the execution from `watchingTrigger`.
    - Otherwise, update the trigger state with the current execution and trigger.
    - Receive messages from the `triggerQueue`.
    - Check if the message from `triggerQueue` is deserialized correctly; log an error if not.
    - If the trigger is valid and has an execution ID, store it in `watchingTrigger`.
    - Call the `super.run()` method to execute any additional logic defined in the superclass.
- **Output**:
    - No direct output; the method updates the state of triggers and logs errors if deserialization fails.
- **Functions Called**:
    - [`io.kestra.core.schedulers.SchedulerTriggerStateInterface.update`](<SchedulerTriggerStateInterface.java.md#schedulertriggerstateinterfaceupdate>)
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)


---
#### DefaultScheduler\.handleNext<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.handleNext}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L88>)

Filters triggers that are due for execution and passes them to a consumer along with a new scheduling context.
- **Modifiers**: `public`, `override`
- **Inputs**:
    - `flows`: A list of `Flow` objects, representing the flows to be processed.
    - `now`: A `ZonedDateTime` object representing the current date and time.
    - `consumer`: A `BiConsumer` that accepts a list of `Trigger` objects and a `ScheduleContextInterface`.
- **Control Flow**:
    - Retrieve all triggers for all tenants using `triggerState.findAllForAllTenants()`.
    - Filter the triggers to include only those with a `null` next execution date or a next execution date before `now`.
    - Convert the filtered triggers to a list.
    - Create a new instance of `DefaultScheduleContext`.
    - Pass the list of triggers and the `DefaultScheduleContext` to the `consumer` using `consumer.accept()`.
- **Output**:
    - The method does not return a value; it operates through side effects by passing data to the provided `BiConsumer`.
- **Functions Called**:
    - [`io.kestra.core.schedulers.SchedulerTriggerStateInterface.findAllForAllTenants`](<SchedulerTriggerStateInterface.java.md#schedulertriggerstateinterfacefindallforalltenants>)
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)




---
Made with ❤️ by [Driver](https://www.driver.ai/)