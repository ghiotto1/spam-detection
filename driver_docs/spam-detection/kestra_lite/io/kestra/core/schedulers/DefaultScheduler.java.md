<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A scheduler for managing and executing flows and triggers in a concurrent environment.

# Purpose
The [`DefaultScheduler`](<#defaultschedulerdefaultscheduler>) class is a component within the `io.kestra.core.schedulers` package that extends the `AbstractScheduler` class. It is responsible for managing the scheduling of tasks and handling triggers within the application. The class is annotated with `@Singleton`, indicating that it is a singleton component managed by the dependency injection framework. The scheduler interacts with various services and repositories, such as `ConditionService` and `FlowRepositoryInterface`, to manage the execution and flow of tasks.

The [`DefaultScheduler`](<#defaultschedulerdefaultscheduler>) class implements the [`run`](<#defaultschedulerrun>) method, which sets up listeners for execution and trigger queues. It uses the `QueueInterface` to receive messages related to task executions and triggers. When an execution is received, the scheduler checks if it is associated with a trigger and updates the trigger state accordingly. It also manages a map of `watchingTrigger` to keep track of active triggers. The [`handleNext`](<#defaultschedulerhandlenext>) method is used to process the next set of flows and triggers, filtering them based on their execution dates. This class is a key component in the scheduling system, ensuring that tasks are executed based on their defined triggers and conditions.
# Imports and Dependencies

---
- `io.kestra.core.schedulers`
- `io.kestra.core.models.executions.Execution`
- `io.kestra.core.models.flows.Flow`
- `io.kestra.core.models.triggers.Trigger`
- `io.kestra.core.queues.QueueFactoryInterface`
- `io.kestra.core.queues.QueueInterface`
- `io.kestra.core.repositories.FlowRepositoryInterface`
- `io.kestra.core.services.ConditionService`
- `io.kestra.core.services.FlowListenersInterface`
- `io.kestra.core.utils.Await`
- `io.micronaut.context.ApplicationContext`
- `io.micronaut.inject.qualifiers.Qualifiers`
- `jakarta.inject.Inject`
- `jakarta.inject.Singleton`
- `lombok.extern.slf4j.Slf4j`
- `java.time.Duration`
- `java.time.ZonedDateTime`
- `java.util.List`
- `java.util.Map`
- `java.util.concurrent.ConcurrentHashMap`
- `java.util.function.BiConsumer`


# Classes

---
### DefaultScheduler<!-- {{#class:io.kestra.core.schedulers.DefaultScheduler}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L25>)

- **Modifiers**: `public`
- **Description**: Implements a scheduling mechanism that manages the execution and triggering of flows based on conditions and states, using a concurrent map to track active triggers and interacting with various services and repositories to handle execution and trigger queues.
- **Fields**:
    - `watchingTrigger`: `Map<String, Trigger>` A concurrent map that tracks active triggers by their execution IDs.
    - `conditionService`: `ConditionService` A service used to evaluate conditions related to flow executions.
    - `flowRepository`: `FlowRepositoryInterface` An interface to access and manage flow data.
- **Methods**:
    - [`io.kestra.core.schedulers.DefaultScheduler.DefaultScheduler`](<#defaultschedulerdefaultscheduler>)
    - [`io.kestra.core.schedulers.DefaultScheduler.run`](<#defaultschedulerrun>)
    - [`io.kestra.core.schedulers.DefaultScheduler.handleNext`](<#defaultschedulerhandlenext>)
- **Extends/Implements**:
    - `AbstractScheduler`

**Methods**

---
#### DefaultScheduler\.DefaultScheduler<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.DefaultScheduler}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L35>)

Initializes a `DefaultScheduler` instance with the given application context, flow listeners, and trigger state, and sets up necessary services.
- **Modifiers**: `public`
- **Inputs**:
    - `applicationContext`: The `ApplicationContext` used to retrieve beans and manage the application environment.
    - `flowListeners`: The `FlowListenersInterface` used to manage flow listeners.
    - `triggerState`: The `SchedulerTriggerStateInterface` used to manage the state of triggers.
- **Control Flow**:
    - Call the superclass constructor with `applicationContext` and `flowListeners`.
    - Assign `triggerState` to the instance variable `this.triggerState`.
    - Retrieve the `ConditionService` bean from `applicationContext` and assign it to `this.conditionService`.
    - Retrieve the `FlowRepositoryInterface` bean from `applicationContext` and assign it to `this.flowRepository`.
- **Output**:
    - A new instance of `DefaultScheduler` is created and initialized with the provided context, listeners, and trigger state.
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)


---
#### DefaultScheduler\.run<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.run}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L48>)

Implements the main execution loop for the scheduler, processing execution and trigger queues.
- **Modifiers**: `public`, `override`
- **Inputs**: None
- **Control Flow**:
    - Retrieve the `executionQueue` and `triggerQueue` beans from the `applicationContext`.
    - Listen for messages on the `executionQueue`.
    - If a message on the `executionQueue` cannot be deserialized, log an error and return.
    - If the `Execution` object has a trigger, attempt to retrieve the corresponding `Trigger` from `watchingTrigger` with a timeout of 5 seconds.
    - Retrieve the `Flow` object associated with the `Execution` from the `flowRepository`.
    - If the `Execution` is deleted or terminated, update the `triggerState` with the reset execution state and remove the `Execution` from `watchingTrigger`.
    - Otherwise, update the `triggerState` with the current `Execution` and `Trigger`.
    - Listen for messages on the `triggerQueue`.
    - If a message on the `triggerQueue` cannot be deserialized, log an error and return.
    - If the `Trigger` object is valid and has an `executionId`, store it in `watchingTrigger`.
    - Call the `super.run()` method to continue the execution flow.
- **Output**:
    - No direct output; the method processes messages from queues and updates internal states.
- **Functions Called**:
    - [`io.kestra.core.schedulers.SchedulerTriggerStateInterface.update`](<SchedulerTriggerStateInterface.java.md#schedulertriggerstateinterfaceupdate>)
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)


---
#### DefaultScheduler\.handleNext<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.handleNext}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L88>)

Filters triggers that are due for execution and passes them to a consumer along with a new scheduling context.
- **Modifiers**: `public`, `override`
- **Inputs**:
    - `flows`: A list of `Flow` objects, representing the flows to be processed.
    - `now`: A `ZonedDateTime` object representing the current date and time.
    - `consumer`: A `BiConsumer` that accepts a list of `Trigger` objects and a `ScheduleContextInterface`.
- **Control Flow**:
    - Retrieve all triggers for all tenants using `triggerState.findAllForAllTenants()`.
    - Filter the triggers to include only those with a `null` next execution date or a next execution date before `now`.
    - Convert the filtered triggers to a list.
    - Create a new instance of `DefaultScheduleContext`.
    - Pass the list of triggers and the `DefaultScheduleContext` to the `consumer` using `consumer.accept()`.
- **Output**:
    - The method does not return a value; it operates through side effects by passing data to the `consumer`.
- **Functions Called**:
    - [`io.kestra.core.schedulers.SchedulerTriggerStateInterface.findAllForAllTenants`](<SchedulerTriggerStateInterface.java.md#schedulertriggerstateinterfacefindallforalltenants>)
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)




---
Made with ❤️ by [Driver](https://www.driver.ai/)