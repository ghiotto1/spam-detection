<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

Implements a default scheduler for managing execution and trigger queues in a spam detection system.

# Purpose
The [`DefaultScheduler`](<#defaultschedulerdefaultscheduler>) class is a component within the `io.kestra.core.schedulers` package that extends the `AbstractScheduler` class. It is responsible for managing the scheduling of tasks and handling the execution and triggering of flows within the application. The class is annotated with `@Singleton`, indicating that it is a singleton component managed by the dependency injection framework. It uses several injected services and interfaces, such as `ConditionService`, `FlowRepositoryInterface`, and `SchedulerTriggerStateInterface`, to perform its operations.

The [`DefaultScheduler`](<#defaultschedulerdefaultscheduler>) class primarily manages two types of queues: `executionQueue` and `triggerQueue`. It listens for incoming `Execution` and `Trigger` objects on these queues, respectively. When an `Execution` is received, the scheduler checks if it is associated with a trigger and updates the trigger state accordingly. It also handles the removal of triggers for executions that are deleted or terminated. For `Trigger` objects, the scheduler adds them to a `watchingTrigger` map for tracking. The [`handleNext`](<#defaultschedulerhandlenext>) method is used to process the next set of triggers based on their execution dates, allowing the scheduler to determine which triggers are ready for execution. This class provides a structured approach to managing the lifecycle of task executions and triggers within the application.
# Imports and Dependencies

---
- `io.kestra.core.schedulers`
- `io.kestra.core.models.executions.Execution`
- `io.kestra.core.models.flows.Flow`
- `io.kestra.core.models.triggers.Trigger`
- `io.kestra.core.queues.QueueFactoryInterface`
- `io.kestra.core.queues.QueueInterface`
- `io.kestra.core.repositories.FlowRepositoryInterface`
- `io.kestra.core.services.ConditionService`
- `io.kestra.core.services.FlowListenersInterface`
- `io.kestra.core.utils.Await`
- `io.micronaut.context.ApplicationContext`
- `io.micronaut.inject.qualifiers.Qualifiers`
- `jakarta.inject.Inject`
- `jakarta.inject.Singleton`
- `lombok.extern.slf4j.Slf4j`
- `java.time.Duration`
- `java.time.ZonedDateTime`
- `java.util.List`
- `java.util.Map`
- `java.util.concurrent.ConcurrentHashMap`
- `java.util.function.BiConsumer`


# Classes

---
### DefaultScheduler<!-- {{#class:io.kestra.core.schedulers.DefaultScheduler}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L25>)

- **Modifiers**: `@Singleton`, `public`
- **Description**: Implements a scheduling mechanism that manages the execution of flows and triggers within an application context. It extends `AbstractScheduler` and uses a concurrent map to track active triggers. The class interacts with execution and trigger queues to process incoming executions and triggers, updating their states based on conditions and flow repository data. It also provides a method to handle the next set of triggers for execution based on their scheduled times.
- **Fields**:
    - `watchingTrigger`: `Map<String, Trigger>` A concurrent map that tracks active triggers by their execution IDs.
    - `conditionService`: `ConditionService` A service used to evaluate conditions related to execution states.
    - `flowRepository`: `FlowRepositoryInterface` An interface to access flow data from the repository.
- **Methods**:
    - [`io.kestra.core.schedulers.DefaultScheduler.DefaultScheduler`](<#defaultschedulerdefaultscheduler>)
    - [`io.kestra.core.schedulers.DefaultScheduler.run`](<#defaultschedulerrun>)
    - [`io.kestra.core.schedulers.DefaultScheduler.handleNext`](<#defaultschedulerhandlenext>)
- **Extends/Implements**:
    - `AbstractScheduler`

**Methods**

---
#### DefaultScheduler\.DefaultScheduler<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.DefaultScheduler}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L35>)

Initializes a `DefaultScheduler` instance with the given application context, flow listeners, and trigger state, and sets up necessary services.
- **Modifiers**: `public`
- **Inputs**:
    - `applicationContext`: The `ApplicationContext` instance used to retrieve beans and manage the application environment.
    - `flowListeners`: The `FlowListenersInterface` instance used to manage flow listeners.
    - `triggerState`: The `SchedulerTriggerStateInterface` instance used to manage the state of triggers.
- **Control Flow**:
    - Calls the superclass constructor with `applicationContext` and `flowListeners`.
    - Assigns the `triggerState` parameter to the `triggerState` field of the class.
    - Retrieves the `ConditionService` bean from the `applicationContext` and assigns it to the `conditionService` field.
    - Retrieves the `FlowRepositoryInterface` bean from the `applicationContext` and assigns it to the `flowRepository` field.
- **Output**:
    - A new instance of `DefaultScheduler` is created and initialized with the provided parameters and services.
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)


---
#### DefaultScheduler\.run<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.run}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L48>)

Implements the main execution loop for processing execution and trigger queues in the scheduler.
- **Modifiers**: `public`, `override`
- **Inputs**: None
- **Control Flow**:
    - Retrieve the `executionQueue` bean from the application context using the `QueueInterface` class and `QueueFactoryInterface.EXECUTION_NAMED` qualifier.
    - Retrieve the `triggerQueue` bean from the application context using the `QueueInterface` class and `QueueFactoryInterface.TRIGGER_NAMED` qualifier.
    - Call `receive` on `executionQueue` to process incoming `Execution` objects.
    - Check if the received `Execution` object is deserialized correctly; log an error if not.
    - If the `Execution` object has a trigger, retrieve the corresponding `Trigger` from `watchingTrigger` with a timeout of 5 seconds.
    - Find the `Flow` object associated with the `Execution` using `flowRepository`.
    - Check if the `Execution` is deleted or terminated; if so, update the `triggerState` and remove the `Execution` from `watchingTrigger`.
    - Otherwise, update the `triggerState` with the current `Execution` and `Trigger`.
    - Call `receive` on `triggerQueue` to process incoming `Trigger` objects.
    - Check if the received `Trigger` object is deserialized correctly; log an error if not.
    - If the `Trigger` object is valid and has an `ExecutionId`, add it to `watchingTrigger`.
    - Call `super.run()` to execute any additional logic defined in the superclass.
- **Output**:
    - No explicit output; the method processes queues and updates internal states.
- **Functions Called**:
    - [`io.kestra.core.schedulers.SchedulerTriggerStateInterface.update`](<SchedulerTriggerStateInterface.java.md#schedulertriggerstateinterfaceupdate>)
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)


---
#### DefaultScheduler\.handleNext<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.handleNext}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L88>)

Filters triggers that are due for execution and passes them to a consumer along with a new scheduling context.
- **Modifiers**: `public`, `override`
- **Inputs**:
    - `flows`: A list of `Flow` objects, representing the flows to be processed.
    - `now`: A `ZonedDateTime` object representing the current date and time.
    - `consumer`: A `BiConsumer` that accepts a list of `Trigger` objects and a `ScheduleContextInterface`.
- **Control Flow**:
    - Retrieve all triggers for all tenants using `triggerState.findAllForAllTenants()`.
    - Filter the triggers to include only those with a `null` next execution date or a next execution date before `now`.
    - Convert the filtered triggers to a list.
    - Create a new instance of `DefaultScheduleContext`.
    - Pass the list of triggers and the `DefaultScheduleContext` to the `consumer` using `consumer.accept()`.
- **Output**:
    - The method does not return a value; it operates by passing data to the provided `BiConsumer`.
- **Functions Called**:
    - [`io.kestra.core.schedulers.SchedulerTriggerStateInterface.findAllForAllTenants`](<SchedulerTriggerStateInterface.java.md#schedulertriggerstateinterfacefindallforalltenants>)
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)




---
Made with ❤️ by [Driver](https://www.driver.ai/)