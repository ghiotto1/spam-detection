<!--------------------------------------------------------------------------------->
<!-- IMPORTANT: This file is auto-generated by Driver (https://driver.ai). -------->
<!-- Manual edits may be overwritten on future commits. --------------------------->
<!--------------------------------------------------------------------------------->

A scheduler for managing and executing flows and triggers in a concurrent environment.

# Purpose
The [`DefaultScheduler`](<#defaultschedulerdefaultscheduler>) class is a component within the `io.kestra.core.schedulers` package that extends the `AbstractScheduler` class. It is responsible for managing the scheduling of tasks and handling triggers within the application. The class is annotated with `@Singleton`, indicating that it is a singleton component managed by the dependency injection framework. It uses several injected services and interfaces, such as `ConditionService`, `FlowRepositoryInterface`, and `SchedulerTriggerStateInterface`, to perform its operations. The class maintains a map of triggers it is watching, which is used to track and manage the execution of tasks.

The [`run`](<#defaultschedulerrun>) method in the [`DefaultScheduler`](<#defaultschedulerdefaultscheduler>) class sets up listeners for execution and trigger queues. It processes incoming execution and trigger messages, updating the state of triggers and managing their lifecycle. The method uses the `QueueInterface` to receive messages and handle deserialization errors. The [`handleNext`](<#defaultschedulerhandlenext>) method is responsible for determining which triggers are ready to be executed based on their scheduled execution dates. It filters triggers that are due for execution and passes them to a consumer for further processing. This class provides a focused functionality for scheduling and managing task executions and triggers within the application.
# Imports and Dependencies

---
- `io.kestra.core.schedulers`
- `io.kestra.core.models.executions.Execution`
- `io.kestra.core.models.flows.Flow`
- `io.kestra.core.models.triggers.Trigger`
- `io.kestra.core.queues.QueueFactoryInterface`
- `io.kestra.core.queues.QueueInterface`
- `io.kestra.core.repositories.FlowRepositoryInterface`
- `io.kestra.core.services.ConditionService`
- `io.kestra.core.services.FlowListenersInterface`
- `io.kestra.core.utils.Await`
- `io.micronaut.context.ApplicationContext`
- `io.micronaut.inject.qualifiers.Qualifiers`
- `jakarta.inject.Inject`
- `jakarta.inject.Singleton`
- `lombok.extern.slf4j.Slf4j`
- `java.time.Duration`
- `java.time.ZonedDateTime`
- `java.util.List`
- `java.util.Map`
- `java.util.concurrent.ConcurrentHashMap`
- `java.util.function.BiConsumer`


# Classes

---
### DefaultScheduler<!-- {{#class:io.kestra.core.schedulers.DefaultScheduler}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L25>)

- **Modifiers**: `@Singleton`, `public`
- **Description**: Implements a scheduling mechanism that manages the execution of flows and triggers within an application context. It extends `AbstractScheduler` and uses a concurrent map to track triggers associated with executions. The class interacts with various services and repositories to manage the state of executions and triggers, ensuring that they are processed correctly based on their conditions and schedules.
- **Fields**:
    - `watchingTrigger`: `Map<String, Trigger>` A concurrent map that tracks triggers associated with their execution IDs.
    - `conditionService`: `ConditionService` A service used to evaluate conditions related to executions and flows.
    - `flowRepository`: `FlowRepositoryInterface` A repository interface for accessing flow data.
- **Methods**:
    - [`io.kestra.core.schedulers.DefaultScheduler.DefaultScheduler`](<#defaultschedulerdefaultscheduler>)
    - [`io.kestra.core.schedulers.DefaultScheduler.run`](<#defaultschedulerrun>)
    - [`io.kestra.core.schedulers.DefaultScheduler.handleNext`](<#defaultschedulerhandlenext>)
- **Extends/Implements**:
    - `AbstractScheduler`

**Methods**

---
#### DefaultScheduler\.DefaultScheduler<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.DefaultScheduler}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L35>)

Initializes a `DefaultScheduler` instance with the given application context, flow listeners, and trigger state, and retrieves necessary services from the application context.
- **Modifiers**: `public`
- **Inputs**:
    - `applicationContext`: The `ApplicationContext` from which beans and services are retrieved.
    - `flowListeners`: The `FlowListenersInterface` used for handling flow events.
    - `triggerState`: The `SchedulerTriggerStateInterface` that manages the state of triggers.
- **Control Flow**:
    - Calls the superclass constructor with `applicationContext` and `flowListeners`.
    - Assigns the `triggerState` parameter to the instance variable `this.triggerState`.
    - Retrieves the `ConditionService` bean from the `applicationContext` and assigns it to `this.conditionService`.
    - Retrieves the `FlowRepositoryInterface` bean from the `applicationContext` and assigns it to `this.flowRepository`.
- **Output**:
    - A new instance of `DefaultScheduler` is created and initialized.
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)


---
#### DefaultScheduler\.run<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.run}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L48>)

Implements the main execution loop for processing `Execution` and `Trigger` objects from their respective queues.
- **Modifiers**: `public`, `override`
- **Inputs**: None
- **Control Flow**:
    - Retrieve `executionQueue` and `triggerQueue` from the application context using `QueueInterface` and specific qualifiers.
    - Receive messages from `executionQueue` and process each message using a lambda function.
    - Check if the message from `executionQueue` is deserialized correctly; log an error if not.
    - If the `Execution` object has a trigger, retrieve the corresponding `Trigger` from `watchingTrigger` with a timeout of 5 seconds.
    - Find the `Flow` object associated with the `Execution` using `flowRepository`.
    - Check if the `Execution` is deleted or terminated; if so, update the `triggerState` and remove the `Execution` from `watchingTrigger`.
    - Otherwise, update the `triggerState` with the current `Execution` and `Trigger`.
    - Receive messages from `triggerQueue` and process each message using a lambda function.
    - Check if the message from `triggerQueue` is deserialized correctly; log an error if not.
    - If the `Trigger` object is valid and has an `ExecutionId`, add it to `watchingTrigger`.
    - Call `super.run()` to execute any additional logic defined in the superclass.
- **Output**:
    - No direct output; the method processes messages from queues and updates internal states.
- **Functions Called**:
    - [`io.kestra.core.schedulers.SchedulerTriggerStateInterface.update`](<SchedulerTriggerStateInterface.java.md#schedulertriggerstateinterfaceupdate>)
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)


---
#### DefaultScheduler\.handleNext<!-- {{#callable:io.kestra.core.schedulers.DefaultScheduler.handleNext}} -->
[View Source →](<../../../../../../../kestra_lite/io/kestra/core/schedulers/DefaultScheduler.java#L88>)

Filters triggers that are ready for execution and passes them to a consumer with a scheduling context.
- **Modifiers**: `public`
- **Inputs**:
    - `flows`: A list of `Flow` objects that represent the flows to handle.
    - `now`: A `ZonedDateTime` object representing the current date and time.
    - `consumer`: A `BiConsumer` that accepts a list of `Trigger` objects and a `ScheduleContextInterface`.
- **Control Flow**:
    - Retrieve all triggers for all tenants using `triggerState.findAllForAllTenants()`.
    - Filter the triggers to include only those with a `null` next execution date or a next execution date before `now`.
    - Convert the filtered triggers to a list.
    - Create a new `DefaultScheduleContext` object.
    - Pass the list of triggers and the `DefaultScheduleContext` to the `consumer` using `consumer.accept()`.
- **Output**:
    - The method does not return a value; it operates through side effects by passing data to the `consumer`.
- **Functions Called**:
    - [`io.kestra.core.schedulers.SchedulerTriggerStateInterface.findAllForAllTenants`](<SchedulerTriggerStateInterface.java.md#schedulertriggerstateinterfacefindallforalltenants>)
- **See also**: [`io.kestra.core.schedulers.DefaultScheduler`](<#defaultscheduler>)  (Base Class)




---
Made with ❤️ by [Driver](https://www.driver.ai/)